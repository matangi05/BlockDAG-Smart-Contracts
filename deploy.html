<!DOCTYPE html>
<html>
<head>
  <title>Deploy Contract</title>
  <!-- Use stable Ethers.js UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.6.9/dist/ethers.umd.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="deploy-container">
  <div class="container">
    <h1>Deploy The Contract</h1>
    <div id="networkWarning" class="network-warning">
      Please switch to BlockDAG Testnet in MetaMask.
      <button id="switchNetworkBtn" class="submit-btn" style="margin-left: 10px; padding: 8px 15px; font-size: 14px; max-width: 200px;">Switch to BlockDAG</button>
    </div>
    
    <div class="button-container">
      <button id="deployBtn" class="submit-btn">Deploy Contract</button>
      <div id="result"></div>
      <button id="interactBtn" class="submit-btn" style="display: none;">Go to Contract Interaction</button>
      <button id="pdfBtn" class="submit-btn">Generate Contract PDF</button>
    </div>
  </div>
  </div>
  <script>
    // BlockDAG Testnet chainId
    const BLOCKDAG_TESTNET_CHAINID = '0x413'; // 1043 in hex

    // Network switching functionality
    document.getElementById('switchNetworkBtn').onclick = async function() {
      if (!window.ethereum) {
        alert('MetaMask is not installed!');
        return;
      }
      
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: BLOCKDAG_TESTNET_CHAINID }],
        });
        // Hide warning after successful switch
        document.getElementById('networkWarning').style.display = 'none';
      } catch (switchError) {
        // This error code indicates that the chain has not been added to MetaMask.
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: BLOCKDAG_TESTNET_CHAINID,
                chainName: 'BlockDAG Testnet',
                nativeCurrency: {
                  name: 'BDAG',
                  symbol: 'BDAG',
                  decimals: 18
                },
                rpcUrls: ['https://test-rpc.primordial.bdagscan.com/'],
                blockExplorerUrls: ['https://test.bdagscan.com/']
              }],
            });
            document.getElementById('networkWarning').style.display = 'none';
          } catch (addError) {
            alert('Failed to add BlockDAG network to MetaMask');
          }
        } else {
          alert('Failed to switch to BlockDAG network');
        }
      }
    };

    // Check network on page load
    window.addEventListener('DOMContentLoaded', async function() {
      if (window.ethereum) {
        try {
          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (chainId !== BLOCKDAG_TESTNET_CHAINID) {
            document.getElementById('networkWarning').style.display = 'block';
          }
        } catch (err) {
          console.log('Network check failed:', err);
        }
      }
    });

    // Real SmartContract ABI and bytecode from Hardhat compilation
    const abi = [
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "_client",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "_freelancer",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "_amount",
            "type": "uint256"
          },
          {
            "internalType": "string",
            "name": "_description",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_deliverables",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_deadline",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_milestones",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "_penalties",
            "type": "string"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "inputs": [],
        "name": "amount",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "client",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "deadline",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "deliverables",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "description",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "freelancer",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "fund",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "isFunded",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "isWithdrawn",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "milestones",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "penalties",
        "outputs": [
          {
            "internalType": "string",
            "name": "",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "withdraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];
    
    const bytecode = "0x608060405234801561001057600080fd5b506040516114d33803806114d383398181016040528101906100329190610356565b876000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555086600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508560028190555084600390816100c991906106af565b5083600490816100d991906106af565b5082600590816100e991906106af565b5081600690816100f991906106af565b50806007908161010991906106af565b506000600860006101000a81548160ff0219169083151502179055506000600860016101000a81548160ff0219169083151502179055505050505050505050610781565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061018c82610161565b9050919050565b61019c81610181565b81146101a757600080fd5b50565b6000815190506101b981610193565b92915050565b6000819050919050565b6101d2816101bf565b81146101dd57600080fd5b50565b6000815190506101ef816101c9565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610248826101ff565b810181811067ffffffffffffffff8211171561026757610266610210565b5b80604052505050565b600061027a61014d565b9050610286828261023f565b919050565b600067ffffffffffffffff8211156102a6576102a5610210565b5b6102af826101ff565b9050602081019050919050565b60005b838110156102da5780820151818401526020810190506102bf565b60008484015250505050565b60006102f96102f48461028b565b610270565b905082815260208101848484011115610315576103146101fa565b5b6103208482856102bc565b509392505050565b600082601f83011261033d5761033c6101f5565b5b815161034d8482602086016102e6565b91505092915050565b600080600080600080600080610100898b03121561037757610376610157565b5b60006103858b828c016101aa565b98505060206103968b828c016101aa565b97505060406103a78b828c016101e0565b965050606089015167ffffffffffffffff8111156103c8576103c761015c565b5b6103d48b828c01610328565b955050608089015167ffffffffffffffff8111156103f5576103f461015c565b5b6104018b828c01610328565b94505060a089015167ffffffffffffffff8111156104225761042161015c565b5b61042e8b828c01610328565b93505060c089015167ffffffffffffffff81111561044f5761044e61015c565b5b61045b8b828c01610328565b92505060e089015167ffffffffffffffff81111561047c5761047b61015c565b5b6104888b828c01610328565b9150509295985092959890939650565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806104ea57607f821691505b6020821081036104fd576104fc6104a3565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026105657fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610528565b61056f8683610528565b95508019841693508086168417925050509392505050565b6000819050919050565b60006105ac6105a76105a2846101bf565b610587565b6101bf565b9050919050565b6000819050919050565b6105c683610591565b6105da6105d2826105b3565b848454610535565b825550505050565b600090565b6105ef6105e2565b6105fa8184846105bd565b505050565b5b8181101561061e576106136000826105e7565b600181019050610600565b5050565b601f8211156106635761063481610503565b61063d84610518565b8101602085101561064c578190505b61066061065885610518565b8301826105ff565b50505b505050565b600082821c905092915050565b600061068660001984600802610668565b1980831691505092915050565b600061069f8383610675565b9150826002028217905092915050565b6106b882610498565b67ffffffffffffffff8111156106d1576106d0610210565b5b6106db82546104d2565b6106e6828285610622565b600060209050601f8311600181146107195760008415610707578287015190505b6107118582610693565b865550610779565b601f19841661072786610503565b60005b8281101561074f5784890151825560018201915060208501945060208101905061072a565b8683101561076c5784890151610768601f891682610675565b8355505b6001600288020188555050505b505050505050565b610d43806107906000396000f3fe6080604052600436106100a75760003560e01c80637c654303116100645780637c6543031461019a578063a37dda2c146101c5578063aa8c217c146101f0578063ad4126b61461021b578063b60d428814610246578063d51695a414610250576100a7565b8063109e94cf146100ac57806329dcb0cf146100d75780633ccfd60b1461010257806342b53a751461011957806344aa5700146101445780637284e4161461016f575b600080fd5b3480156100b857600080fd5b506100c161027b565b6040516100ce91906108ee565b60405180910390f35b3480156100e357600080fd5b506100ec61029f565b6040516100f99190610999565b60405180910390f35b34801561010e57600080fd5b5061011761032d565b005b34801561012557600080fd5b5061012e6104e4565b60405161013b9190610999565b60405180910390f35b34801561015057600080fd5b50610159610572565b60405161016691906109d6565b60405180910390f35b34801561017b57600080fd5b50610184610585565b6040516101919190610999565b60405180910390f35b3480156101a657600080fd5b506101af610613565b6040516101bc91906109d6565b60405180910390f35b3480156101d157600080fd5b506101da610626565b6040516101e791906108ee565b60405180910390f35b3480156101fc57600080fd5b5061020561064c565b6040516102129190610a0a565b60405180910390f35b34801561022757600080fd5b50610230610652565b60405161023d9190610999565b60405180910390f35b61024e6106e0565b005b34801561025c57600080fd5b5061026561081f565b6040516102729190610999565b60405180910390f35b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600580546102ac90610a54565b80601f01602080910402602001604051908101604052809291908181526020018280546102d890610a54565b80156103255780601f106102fa57610100808354040283529160200191610325565b820191906000526020600020905b81548152906001019060200180831161030857829003601f168201915b505050505081565b600860009054906101000a900460ff1661037c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161037390610ad1565b60405180910390fd5b600860019054906101000a900460ff16156103cc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103c390610b3d565b60405180910390fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461045c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161045390610ba9565b60405180910390fd5b6001600860016101000a81548160ff021916908315150217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6002549081150290604051600060405180830381858888f193505050501580156104e1573d6000803e3d6000fd5b50565b600780546104f190610a54565b80601f016020809104026020016040519081016040528092919081815260200182805461051d90610a54565b801561056a5780601f1061053f5761010080835404028352916020019161056a565b820191906000526020600020905b81548152906001019060200180831161054d57829003601f168201915b505050505081565b600860019054906101000a900460ff1681565b6003805461059290610a54565b80601f01602080910402602001604051908101604052809291908181526020018280546105be90610a54565b801561060b5780601f106105e05761010080835404028352916020019161060b565b820191906000526020600020905b8154815290600101906020018083116105ee57829003601f168201915b505050505081565b600860009054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60025481565b6006805461065f90610a54565b80601f016020809104026020016040519081016040528092919081815260200182805461068b90610a54565b80156106d85780601f106106ad576101008083540402835291602001916106d8565b820191906000526020600020905b8154815290600101906020018083116106bb57829003601f168201915b505050505081565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461076e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161076590610c15565b60405180910390fd5b600860009054906101000a900460ff16156107be576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107b590610c81565b60405180910390fd5b6002543414610802576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107f990610ced565b60405180910390fd5b6001600860006101000a81548160ff021916908315150217905550565b6004805461082c90610a54565b80601f016020809104026020016040519081016040528092919081815260200182805461085890610a54565b80156108a55780601f1061087a576101008083540402835291602001916108a5565b820191906000526020600020905b81548152906001019060200180831161088857829003601f168201915b505050505081565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006108d8826108ad565b9050919050565b6108e8816108cd565b82525050565b600060208201905061090360008301846108df565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610943578082015181840152602081019050610928565b60008484015250505050565b6000601f19601f8301169050919050565b600061096b82610909565b6109758185610914565b9350610985818560208601610925565b61098e8161094f565b840191505092915050565b600060208201905081810360008301526109b38184610960565b905092915050565b60008115159050919050565b6109d0816109bb565b82525050565b60006020820190506109eb60008301846109c7565b92915050565b6000819050919050565b610a04816109f1565b82525050565b6000602082019050610a1f60008301846109fb565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610a6c57607f821691505b602082108103610a7f57610a7e610a25565b5b50919050565b7f4e6f742066756e64656420796574000000000000000000000000000000000000600082015250565b6000610abb600e83610914565b9150610ac682610a85565b602082019050919050565b60006020820190508181036000830152610aea81610aae565b9050919050565b7f416c72656164792077697468647261776e000000000000000000000000000000600082015250565b6000610b27601183610914565b9150610b3282610af1565b602082019050919050565b60006020820190508181036000830152610b5681610b1a565b9050919050565b7f4f6e6c7920667265656c616e6365722063616e20776974686472617700000000600082015250565b6000610b93601c83610914565b9150610b9e82610b5d565b602082019050919050565b60006020820190508181036000830152610bc281610b86565b9050919050565b7f4f6e6c7920636c69656e742063616e2066756e64000000000000000000000000600082015250565b6000610bff601483610914565b9150610c0a82610bc9565b602082019050919050565b60006020820190508181036000830152610c2e81610bf2565b9050919050565b7f416c72656164792066756e646564000000000000000000000000000000000000600082015250565b6000610c6b600e83610914565b9150610c7682610c35565b602082019050919050565b60006020820190508181036000830152610c9a81610c5e565b9050919050565b7f496e636f727265637420616d6f756e7400000000000000000000000000000000600082015250565b6000610cd7601083610914565b9150610ce282610ca1565b602082019050919050565b60006020820190508181036000830152610d0681610cca565b905091905056fea2646970667358221220248803f89ce6e09111dffe4db0df0ed45e0491efe68e49aeaf387074c05157a464736f6c634300081c0033";

    document.getElementById('deployBtn').onclick = async () => {
      if (!window.ethereum) return alert("Install MetaMask!");

      // Check if we're on the correct network
      try {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== BLOCKDAG_TESTNET_CHAINID) {
          alert('Please switch to BlockDAG Testnet before deploying. Use the "Switch to BlockDAG" button above.');
          return;
        }
      } catch (err) {
        console.log('Network check failed:', err);
      }

      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();

      // Get contract details from localStorage
      const contractDetails = JSON.parse(localStorage.getItem('contractDetails'));
      if (!contractDetails) {
        document.getElementById('result').textContent = "No contract details found. Please create a contract first.";
        return;
      }

      // Parse payment amount (assume BDAG, e.g. '12BDAG' or '12')
      let paymentStr = contractDetails.payment.replace(/[^0-9.]/g, '');
      if (!paymentStr) paymentStr = '0';
      const amount = ethers.utils.parseEther(paymentStr);

      // Prepare constructor arguments
      const args = [
        contractDetails.from.address,
        contractDetails.to.address,
        amount,
        contractDetails.description,
        contractDetails.deliverables,
        contractDetails.deadline,
        contractDetails.milestones,
        contractDetails.penalties
      ];

      // Debug logging
      console.log('Contract Details:', contractDetails);
      console.log('Constructor Arguments:', args);
      console.log('Amount in wei:', amount.toString());
      console.log('Client address:', contractDetails.from.address);
      console.log('Freelancer address:', contractDetails.to.address);

      const factory = new ethers.ContractFactory(abi, bytecode, signer);
      document.getElementById('result').textContent = "Deploying...";
      document.getElementById('result').className = 'info';
      try {
        const contract = await factory.deploy(...args);
        document.getElementById('result').textContent = "Waiting for confirmation...";
        document.getElementById('result').className = 'info';
        console.log('Transaction hash:', contract.deployTransaction.hash);
        console.log('Waiting for confirmation...');
        await contract.deployed();
        console.log('Contract deployed successfully!');
        document.getElementById('result').textContent = "Deployed at: " + contract.address;
        document.getElementById('result').className = 'success';
        localStorage.setItem('deployedContractAddress', contract.address);
        document.getElementById('interactBtn').style.display = '';
      } catch (err) {
        console.error('Deployment error:', err);
        document.getElementById('result').textContent = "Error: " + err.message;
        document.getElementById('result').className = 'error';
      }
    };
    document.getElementById('interactBtn').onclick = function() {
      window.location.href = 'contractInteract.html';
    };

    // PDF generation logic
    document.getElementById('pdfBtn').onclick = async () => {
      const contractDetails = JSON.parse(localStorage.getItem('contractDetails'));
      if (!contractDetails) {
        alert('No contract details found. Please create a contract first.');
        return;
      }
      document.getElementById('pdfBtn').textContent = 'Generating...';
      document.getElementById('pdfBtn').disabled = true;
      try {
        const res = await fetch('http://localhost:3001/generate-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contractDetails })
        });
        if (!res.ok) throw new Error('PDF generation failed');
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'contract.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert('Error: ' + err.message);
      }
      document.getElementById('pdfBtn').textContent = 'Generate Contract PDF';
      document.getElementById('pdfBtn').disabled = false;
    };
  </script>
</body>
</html>
